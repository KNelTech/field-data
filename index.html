<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Concare Tool Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0f1114;color:#e8eaed;min-height:100vh;-webkit-tap-highlight-color:transparent}

.header{position:sticky;top:0;z-index:100;background:rgba(15,17,20,.92);backdrop-filter:blur(12px);border-bottom:1px solid #333842;padding:14px 16px;display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:10px}
.logo{width:32px;height:32px;background:#3b82f6;border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#fff}
.header h1{font-size:16px;font-weight:700}
.header .date{font-family:'JetBrains Mono',monospace;font-size:12px;color:#9aa0ab}

.main{padding:12px;max-width:800px;margin:0 auto;padding-bottom:100px}

.add-row{background:#1a1d23;border:1px dashed #333842;border-radius:12px;padding:14px;display:flex;gap:10px;margin-bottom:12px}
.add-row select{flex:1;background:#22262e;border:1px solid #333842;border-radius:8px;color:#e8eaed;font-family:'DM Sans',sans-serif;font-size:14px;padding:10px 12px;outline:none}
.add-row button{background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:600;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif}

.card{background:#1a1d23;border:1px solid #333842;border-radius:12px;margin-bottom:10px;overflow:hidden}
.card-head{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.card-info{display:flex;align-items:center;gap:10px}
.avatar{width:34px;height:34px;border-radius:8px;background:#2a2f38;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#3b82f6;flex-shrink:0}
.card-name{font-weight:600;font-size:14px}
.chev{color:#9aa0ab;font-size:18px;transition:transform .2s}
.card.open .chev{transform:rotate(180deg)}
.card-body{display:none;border-top:1px solid #333842;padding:8px}
.card.open .card-body{display:block}

.entry{background:#22262e;border:1px solid #333842;border-radius:10px;padding:10px;margin-bottom:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;position:relative}
.entry select,.entry input[type="time"]{background:#1a1d23;border:1px solid #333842;border-radius:7px;color:#e8eaed;font-family:'DM Sans',sans-serif;font-size:13px;padding:8px;outline:none}
.entry select:focus,.entry input:focus{border-color:#3b82f6}
.entry .tsel{flex:1;min-width:120px}
.tg{display:flex;align-items:center;gap:4px}
.tg input{width:110px;font-family:'JetBrains Mono',monospace!important;color-scheme:dark}
.tg span{color:#9aa0ab;font-size:12px}
.xbtn{background:none;border:none;color:#9aa0ab;font-size:18px;cursor:pointer;padding:4px;border-radius:6px;flex-shrink:0}
.xbtn:hover{color:#ef4444}

.add-entry{width:100%;background:#0f1114;border:1px dashed #333842;border-radius:8px;color:#9aa0ab;font-family:'DM Sans',sans-serif;font-size:13px;padding:10px;cursor:pointer;margin-top:4px}
.add-entry:hover{border-color:#3b82f6;color:#3b82f6}
.del-person{float:right;background:none;border:none;color:#9aa0ab;font-size:12px;cursor:pointer;padding:5px 8px;border-radius:6px;font-family:'DM Sans',sans-serif;margin-top:6px}
.del-person:hover{color:#ef4444}

.bottom{position:fixed;bottom:0;left:0;right:0;background:rgba(15,17,20,.95);backdrop-filter:blur(12px);border-top:1px solid #333842;padding:12px 16px;display:flex;justify-content:center;z-index:100}
.bottom button{background:#3b82f6;color:#fff;border:none;border-radius:10px;padding:12px 24px;font-size:15px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;width:100%;max-width:400px}
.bottom button:disabled{opacity:.5}

.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);font-weight:600;font-size:14px;padding:12px 24px;border-radius:10px;z-index:300;opacity:0;transition:all .3s;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:250;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.overlay.show{display:flex}
.spin{width:40px;height:40px;border:3px solid #333842;border-top-color:#3b82f6;border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

.clear-btn{background:none;border:1px solid #333842;border-radius:7px;color:#9aa0ab;font-family:'DM Sans',sans-serif;font-size:12px;padding:6px 12px;cursor:pointer}
.clear-btn:hover{border-color:#ef4444;color:#ef4444}

@media(max-width:500px){
  .entry{flex-direction:column;align-items:stretch;gap:6px;padding-right:30px}
  .entry .tsel{width:100%}
  .xbtn{position:absolute;top:8px;right:8px}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">C</div>
    <div><div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:#3b82f6">CONCARE</div><h1>Tool Tracker</h1><div class="date" id="dateDisp"></div></div>
  </div>
  <button class="clear-btn" onclick="clearAll()">Clear All</button>
</div>

<div class="main">
  <div class="add-row">
    <select id="addSel"></select>
    <button onclick="addPerson()">Add</button>
  </div>
  <div id="cards"></div>
</div>

<div class="bottom"><button id="subBtn" onclick="doSubmit()">ðŸ“‹ Submit Report</button></div>
<div class="toast" id="toast"></div>
<div class="overlay" id="ov"><div class="spin"></div><div style="color:#e8eaed;font-size:16px;font-weight:600">Sending...</div></div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
const NAMES=["Alejandro Rodriguez","Alex Alfredo Ugsha-Otto","Alexander Moro","Angel G Godoy","Artur Gurgul","Charlie Perez","Jesus Rodriguez","Jose Colon","Jose A Cortes","Jose M Cuyachamin-Espin","Manual Ivan Ugsha-Tigasi","Marcos Martinez","Martin Jimenez","Omar Duran","Oronzo Mendrano","Saul Corona","Wilfredo David Guaman-Ortega"];
const TOOLS=["18V Blower 2824-20","18V Rapid Charger","18V Rotary Hammer Set RHS 2912-22","18V Vacuum 0970-20",'4" Cut-off-Grinder','4" Makita Grinder','4.5" Angle Grinder','5" Makita Grinder','5" Orbital Sander',"Angle Grinder 2881-20","Battery 5.1 AH (2 pcs)","Caulking Gun","Charger M12-M18 4859-1812","Chipping Hammer","Circular Saw 2730-20","Clarke Buffer","Cordless Drill 18V","Demolition Hammer","Festool Sander","Hammer Drill","Hammer Drill 2904-20","Hilti DGH 130 Grinder","Impact Drive 2953-20","Laser Pacific PLS360","M12 Laser Set 3632-21","Makita Die Grinder",'Metabo 7" Crack Saw','Metabo 7" Grinder',"Milwaukee Combo Kit","Milwaukee Mixer","Packout 2 Drawer Box","Packout Base","Saw Zall 2821-20","Stone Grinder",'Wood Saw 7"'];

let uid = 0;
let usedNames = [];

function id() { return 'x' + (uid++); }

function toolOpts(selected) {
  let h = '<option value="">Select tool...</option>';
  TOOLS.forEach(t => {
    const s = t === selected ? ' selected' : '';
    h += `<option value="${t.replace(/"/g,'&quot;')}"${s}>${t}</option>`;
  });
  return h;
}

function initials(n) { return n.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase(); }

function refreshDropdown() {
  const sel = document.getElementById('addSel');
  sel.innerHTML = '<option value="">+ Add crew member...</option>';
  NAMES.filter(n => !usedNames.includes(n)).forEach(n => {
    sel.innerHTML += `<option value="${n}">${n}</option>`;
  });
}

function addPerson(data) {
  const name = data ? data.name : document.getElementById('addSel').value;
  if (!name) return;

  usedNames.push(name);
  const cardId = id();

  // Close all existing cards
  document.querySelectorAll('.card').forEach(c => c.classList.remove('open'));

  const entries = data && data.entries ? data.entries : [{}];
  const entriesHtml = entries.map(e => makeEntry(id(), e.tool, e.t1, e.t2)).join('');

  const card = document.createElement('div');
  card.className = 'card open';
  card.id = cardId;

  card.innerHTML = `
    <div class="card-head">
      <div class="card-info">
        <div class="avatar">${initials(name)}</div>
        <div><div class="card-name">${name}</div></div>
      </div>
      <span class="chev">â–¾</span>
    </div>
    <div class="card-body">
      <div class="entries" id="entries-${cardId}">
        ${entriesHtml}
      </div>
      <button class="add-entry" onclick="addEntry('${cardId}')">+ Add tool entry</button>
      <button class="del-person" data-name="${name}" onclick="removePerson('${cardId}',this.dataset.name)">Remove ${name.split(' ')[0]}</button>
    </div>
  `;

  // Toggle open/close on header click
  card.querySelector('.card-head').addEventListener('click', () => {
    card.classList.toggle('open');
  });

  document.getElementById('cards').appendChild(card);
  refreshDropdown();
  if (!data) saveState();
}

function makeEntry(eid, tool, t1, t2) {
  return `<div class="entry" id="${eid}">
    <select class="tsel">${toolOpts(tool)}</select>
    <div class="tg">
      <input type="time" value="${t1 || ''}">
      <span>â†’</span>
      <input type="time" value="${t2 || ''}">
    </div>
    <button class="xbtn" onclick="removeEntry('${eid}')">Ã—</button>
  </div>`;
}

function addEntry(cardId) {
  const container = document.getElementById('entries-' + cardId);
  if (!container) return;
  if (container.children.length >= 20) { toast('Max 20 entries', true); return; }
  container.insertAdjacentHTML('beforeend', makeEntry(id()));
  saveState();
}

function removeEntry(eid) {
  const el = document.getElementById(eid);
  if (!el) return;
  const container = el.parentElement;
  el.remove();
  // If no entries left, add a blank one
  if (container.children.length === 0) {
    container.insertAdjacentHTML('beforeend', makeEntry(id()));
  }
  saveState();
}

function removePerson(cardId, name) {
  if (!confirm('Remove ' + name.split(' ')[0] + '?')) return;
  const card = document.getElementById(cardId);
  if (card) card.remove();
  usedNames = usedNames.filter(n => n !== name);
  refreshDropdown();
  saveState();
}

function toast(msg, err) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = err ? '#ef4444' : '#22c55e';
  t.style.color = err ? '#fff' : '#000';
  t.className = 'toast';
  requestAnimationFrame(() => t.classList.add('show'));
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€ Report: just read the DOM directly â”€â”€
function fmt(t) {
  if (!t) return 'â€”';
  const [h,m] = t.split(':').map(Number);
  return (h%12||12) + ':' + m.toString().padStart(2,'0') + (h>=12?' PM':' AM');
}

function buildReport() {
  const now = new Date();
  const d = now.toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric'});
  let r = `CONCARE DAILY TOOL USAGE REPORT\nDate: ${d}\nGenerated: ${now.toLocaleTimeString('en-US')}\n${'â”€'.repeat(45)}`;
  let total = 0;
  let peopleCount = 0;

  document.querySelectorAll('.card').forEach(card => {
    const name = card.querySelector('.card-name').textContent;
    const entries = [];

    card.querySelectorAll('.entry').forEach(row => {
      const tool = row.querySelector('.tsel').value;
      if (!tool) return;
      const times = row.querySelectorAll('input[type="time"]');
      entries.push({ tool, t1: times[0].value, t2: times[1].value });
    });

    if (!entries.length) return;
    peopleCount++;
    r += `\n\nâ–¸ ${name.toUpperCase()}`;
    entries.forEach((e, i) => {
      total++;
      r += `\n  ${(i+1).toString().padStart(2)}.  ${e.tool}\n      ${fmt(e.t1)} â†’ ${fmt(e.t2)}`;
    });
  });

  r += `\n\n${'â”€'.repeat(45)}\nSUMMARY: ${peopleCount} crew, ${total} tools`;
  return { report: r, total };
}

async function doSubmit() {
  const { report, total } = buildReport();
  if (!total) { toast('No data yet', true); return; }

  // Validate all time fields are complete
  let incomplete = false;
  document.querySelectorAll('.card').forEach(card => {
    card.querySelectorAll('.entry').forEach(row => {
      const tool = row.querySelector('.tsel').value;
      if (!tool) return;
      const times = row.querySelectorAll('input[type="time"]');
      if (!times[0].value || !times[1].value) {
        incomplete = true;
        times.forEach(t => { if (!t.value) t.style.borderColor = '#ef4444'; });
      }
    });
  });
  if (incomplete) { toast('Fill in all time fields', true); return; }

  const btn = document.getElementById('subBtn');
  btn.disabled = true;
  document.getElementById('ov').classList.add('show');
  const ds = new Date().toLocaleDateString('en-US');

  try {
    if (typeof emailjs === 'undefined' || !emailjs.send) {
      throw new Error('EmailJS library failed to load');
    }
    await emailjs.send("service_concare", "template_concare", {
      to_email: "kodi.nelson@concare.com",
      subject: 'Tool Report â€” ' + ds,
      message: report
    });
    document.getElementById('ov').classList.remove('show');
    toast('âœ“ Report sent!');
    document.getElementById('cards').innerHTML = '';
    usedNames = [];
    localStorage.removeItem('concare_tool_data');
    refreshDropdown();
    btn.disabled = false;
  } catch(e) {
    document.getElementById('ov').classList.remove('show');
    btn.disabled = false;
    const msg = e?.text || e?.message || 'Unknown error';
    toast('Send failed: ' + msg, true);
    console.error('EmailJS error:', e);
  }
}

// â”€â”€ Persistence â”€â”€
function saveState() {
  const data = [];
  document.querySelectorAll('.card').forEach(card => {
    const name = card.querySelector('.card-name').textContent;
    const entries = [];
    card.querySelectorAll('.entry').forEach(row => {
      const tool = row.querySelector('.tsel').value;
      const times = row.querySelectorAll('input[type="time"]');
      entries.push({ tool: tool || '', t1: times[0].value || '', t2: times[1].value || '' });
    });
    data.push({ name, entries });
  });
  localStorage.setItem('concare_tool_data', JSON.stringify(data));
}

function loadState() {
  try {
    const saved = localStorage.getItem('concare_tool_data');
    if (!saved) return;
    JSON.parse(saved).forEach(person => addPerson(person));
  } catch(e) {
    localStorage.removeItem('concare_tool_data');
  }
}

function clearAll() {
  if (!document.querySelectorAll('.card').length) return;
  if (!confirm('Clear all entries and start over?')) return;
  document.getElementById('cards').innerHTML = '';
  usedNames = [];
  localStorage.removeItem('concare_tool_data');
  refreshDropdown();
  toast('All cleared');
}

// Auto-save on any change inside cards
document.addEventListener('input', e => {
  if (e.target.type === 'time') {
    if (e.target.value) e.target.style.borderColor = '';
    saveState();
  }
});
document.addEventListener('change', e => {
  if (e.target.closest('.card')) saveState();
});

// Init
document.getElementById('dateDisp').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
if (typeof emailjs !== 'undefined') {
  emailjs.init({publicKey:"Nfl704un2wQ_vjMKd"});
} else {
  console.error('EmailJS library not loaded â€” check network/CDN');
}
refreshDropdown();
loadState();
</script>
</body>
</html>
